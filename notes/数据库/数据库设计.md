## 数据库设计

### 一、简介

一般情况下数据量不大的表不会进行分库分表操作，如果某些表每天会产生大量的数据，以至于一张表无法搞定，那么就需要想办法将数据放到多个地方，目前比较普遍的方案有三个：

1. 分区
2. 分库分表
3. NoSQL/NewSQL

说明：NoSQL比较具有代表性的是MongoDB、ElasticSearch；NewSQL比较具有代表性的是TiDB。

### 二、分库分表的思路

分库分表的第一步也是最重要的一步是选取sharding column，sharding column选择的好坏将直接决定整个分库分表方案最终是否成功。而sharding column的选取跟业务强相关，所以选择sharding column的方法最主要分析API流量，优先考虑流量大的API，将流量比较大的API对应的SQL提取出来，将这些SQL共同的条件作为sharding column。例如一般的系统都是对用户提供服务，这些API对应的SQL都有条件用户ID，那么，用户ID就是非常好的sharding column。

分库分表的几种处理思路：

1. 只选取一个sharding column进行分库分表 ；
2. 多个sharding column多个分库分表；
3. sharding column分库分表 + es；

例如：

订单表

order_id	user_id	merchant_code	order_amount	order_time	remark

这里选择三个column作为三个独立的sharding column，即：order_id，user_id，merchant_code。user_id和merchant_id是买家ID和卖家ID，因为订单系统中买家和卖家的查询流量都比较大，并且对实时性要求都很高。而根据order_id进行查询的也比较多。

**冗余全量**的情况下，每个sharding列对应的表的数据都是全量的，这样做的优点是不需要二次查询，性能更好，缺点是比较浪费存储空间：

**order_id**	user_id	merchant_code	order_amount	order_time	remark	(t_order表)

**user_id**	order_id	merchant_code	order_amount	order_time	remark	(t_user_order表)

**merchant_code**	order_id	user_id	order_amount	order_time	remark	(t_merchant_order表)

**冗余关系索引表**的情况下，只有一个sharding column的分库分表的数据是全量的，其他分库分表只是与这个sharding column的关系表，只有做的优点是节省空间，缺点是除了第一个sharding column的查询，其他sharding column的查询都需要二次查询，这三张表的关系如下所示：

**order_id**	user_id	merchant_code	order_amount	order_time	remark	(t_order表)

**user_id**	order_id	(t_user_order表)

**merchant_code**	order_id	(t_merchant_order表)

**冗余全量表 PK 冗余关系表**

1. 速度对比：冗余全量表速度更快，冗余关系表需要二次查询，即使有引入缓存，还是多一次网络开销；
2. 存储成本：冗余全量表需要几倍于冗余关系表的存储成本；
3. 维护代价：冗余全量表维护代价更大，涉及到数据变更时，多张表都要进行修改。

### 三、垂直拆分

垂直拆分是指按照业务将表进行分类，分布到不同的数据库上面，这样就将数据分摊到了不同的库上了。

优点：

1. 拆分后业务清晰，拆分规则明确
2. 系统之间整合或扩展容易
3. 数据维护简单
4. 方便做微服务

缺点：

1. 部分业务表无法join，只能通过接口方式解决，提高了系统复杂度
2. 受每种业务不同的限制存在单库性能瓶颈，不利于数据扩展和性能提升
3. 事物处理复杂

### 四、水平拆分

垂直拆分后遇到的性能瓶颈，可以使用水平拆分。相对于垂直拆分的区别是：垂直拆分是把不同的表拆到不同的数据库中，而水平拆分是把同一个表拆分到不同的数据库中。

相对于垂直拆分，水平拆分不是将表的数据做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中包含一部分数据。简单来说，我们可以将数据的水平切分理解为是按照数据行的切分，就是将表中 的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中，主要有分表，分库两种模式。

优点：

1. 不存在单库大数据，高并发的性能瓶颈
2. 对应用透明，应用端改造较少
3. 按照合理拆分规则拆分，join操作基本避免跨库
4. 提高了系统的稳定性跟负载能力

缺点：

1. 拆分规则难以抽象
2. 分片事务一致性难以解决
3. 数据多次扩展难度跟维护量极大
4. 跨库join性能较差

### 五、拆分的难点

两种方式共同的缺点：

1. 引入分布式事务的问题
2. 跨节点Join 的问题
3. 跨节点合并排序分页问题

针对数据源管理，目前主要有两种思路：

1. 客户端模式，在每个应用程序模块中配置管理自己需要的一个（或者多个）数据源，直接访问各个 数据库，在模块内完成数据的整合。 
   优点：相对简单，无性能损耗。   
   缺点：不够通用，数据库连接的处理复杂，对业务不够透明，处理复杂。

2. 通过中间代理层来统一管理所有的数据源，后端数据库集群对前端应用程序透明

   优点：通用，对应用透明，改造少

   缺点：实现难度大，有二次转发性能损失

### 六、拆分原则

1. 尽量不拆分，架构是进化而来，不是一蹴而就
2. 最大可能的找到最合适的切分维度
3. 由于数据库中间件对数据Join 实现的优劣难以把握，而且实现高性能难度极大，业务读取  尽量少使用多表Join -尽量通过数据冗余，分组避免数据垮库多表join
4. 尽量避免分布式事务
5. 单表拆分到数据1000万以内

### 七、拆分方案

1. 范围
2. 枚举
3. 时间
4. 取模
5. 哈希
6. 指定 ...