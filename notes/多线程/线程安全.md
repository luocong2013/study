## 线程安全

### 一、什么是线程（不）安全

**线程不安全**，是不提供数据访问保护，有可能出现多个线程先后更改数据造成所得到的数据是脏数据。

```java
public class RunnableDemo {

    private long count;

    public void incrementCount() {
        for (int i = 0; i < 10; i++) {
            count++;
            System.out.println(count);
            try {
                TimeUnit.MILLISECONDS.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
public class RunnableTask implements Runnable {

    private RunnableDemo runnableDemo;

    public RunnableTask(RunnableDemo runnableDemo) {
        this.runnableDemo = runnableDemo;
    }

    @Override
    public void run() {
        runnableDemo.incrementCount();
    }
}
public class ThreadClient {

    public static void main(String[] args) throws Exception {
        ExecutorService executorService = new ThreadPoolExecutor(10, 16, 20, TimeUnit.SECONDS,
                new LinkedBlockingQueue<>(1000), new BasicThreadFactory.Builder().namingPattern("example-%d").daemon(false).build());
        RunnableDemo runnableDemo = new RunnableDemo();
        for (int i = 0; i < 10; i++) {
            executorService.execute(new RunnableTask(runnableDemo));
        }
    }
}

输出结果：
.........
65
67
68
66
66
69
70
71
71
71
72
75
74
73
73
76
77
```

**线程安全**，是当多线程访问时，采用加锁机制，当一个线程访问该类的某个数据时，进行保护，其他线程不能进行访问直到该线程读取完毕，其他线程才可以使用，不会出现数据不一致或者数据污染的问题。

改造上面线程不安全代码的RunnableDemo.java

```java
public class RunnableDemo {

    private long count;

    private Lock lock = new ReentrantLock();

    public void incrementCount() {
        for (int i = 0; i < 10; i++) {
            lock.lock();
            try {
                count++;
                System.out.println(count);
            } finally {
                lock.unlock();
            }
            try {
                TimeUnit.MILLISECONDS.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```



### 二、为什么会有线程安全问题

线程安全问题一般都是由全局变量或静态变量引起的。

若每个线程中对全局变量、静态变量只有读操作，而无写操作，一般来说，这个全局变量是线程安全的；若是有多个线程同时执行写操作，一般都需要考虑线程同步，否则的话可能有线程安全问题。